# CNI èˆ‡ VNet æ¶æ§‹æ·±åº¦åˆ†æ

## æ¦‚è¿°

æœ¬æ–‡æª”æ·±å…¥åˆ†æ Azure CNI èˆ‡ VNet çš„æ¶æ§‹é—œä¿‚ï¼Œä»¥åŠé›²ç«¯èˆ‡åœ°ç«¯ CNI å¯¦ä½œçš„æ ¹æœ¬å·®ç•°ã€‚

## ğŸ” Azure CNI èˆ‡ VNet çš„ç¶å®šæ©Ÿåˆ¶

### AKS ç¶²è·¯æ¶æ§‹ç¾ç‹€

#### ç•¶å‰é…ç½®
```
VNet: vnet-aks-dev (10.0.0.0/8)
â”œâ”€â”€ Service CIDR: 10.0.0.0/24    â† Kubernetes Services (è™›æ“¬ç¶²è·¯)
â”œâ”€â”€ DNS Service:  10.0.0.10      â† CoreDNS
â”œâ”€â”€ AKS Subnet:   10.0.1.0/24    â† Node Pool & Pod IP (CNI ç®¡ç†)
â”œâ”€â”€ AGW Subnet:   10.0.2.0/24    â† Application Gateway (CNI ä¸ç®¡ç†)
â””â”€â”€ å¯ç”¨ç©ºé–“:     10.0.3.0/24+   â† æœªä¾† Node Pool å¯ç”¨
```

#### CNI ç®¡ç†ç¯„åœé©—è­‰
- **å·²ç®¡ç†çš„ Subnet**: 10.0.1.0/24 (é€é Node Pool æŒ‡å®š)
- **å·²ä½¿ç”¨çš„ Pod IP**: 10.0.1.10~10.0.1.57 (å¯¦éš›åˆ†é…)
- **ä¸å—ç®¡ç†**: 10.0.2.0/24 (Application Gateway å°ˆç”¨)

### Azure CNI çš„å‹•æ…‹ç®¡ç†æ©Ÿåˆ¶

#### æ ¸å¿ƒé‹ä½œåŸç†
```
Azure CNI çš„å‹•æ…‹ç¶å®šæµç¨‹ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. å»ºç«‹ Node Pool æ™‚æŒ‡å®š subnet         â”‚
â”‚ 2. Azure è‡ªå‹•å°‡è©² subnet åŠ å…¥ CNI ç®¡ç†  â”‚
â”‚ 3. CNI Agent åœ¨æ–°ç¯€é»ä¸Šå•Ÿå‹•             â”‚
â”‚ 4. å¾æŒ‡å®š subnet é åˆ†é… IP æ±  (30å€‹/ç¯€é»)â”‚
â”‚ 5. å‹•æ…‹åˆ†é… IP çµ¦æ–°å»ºçš„ Pod             â”‚
â”‚ 6. è‡ªå‹•å»ºç«‹è·¨ subnet è·¯ç”±è¦å‰‡           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### ç‚ºä»€éº¼å¯ä»¥è·¨ Subnet é€šè¨Šï¼Ÿ
1. **VNet å…§å»ºè·¯ç”±**: Azure VNet é è¨­åŒ VNet å…§æ‰€æœ‰ subnet äº’é€š
2. **çœŸå¯¦ IP åˆ†é…**: Pod å–å¾—çœŸå¯¦çš„ VNet IPï¼Œç„¡éœ€ NAT
3. **Azure Fabric è·¯ç”±**: åº•å±¤è‡ªå‹•ç®¡ç†è·¯ç”±è¡¨
4. **Kubernetes Service**: è·¨ subnet é€æ˜é‹ä½œ

## ğŸ†š é›²ç«¯ vs åœ°ç«¯ CNI æ¯”è¼ƒ

### Azure CNI çš„é›²ç«¯å„ªå‹¢

#### å¹³å°æ·±åº¦æ•´åˆ
```
Azure CNI ç¨ç‰¹èƒ½åŠ›ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. Azure API çŸ¥é“ VNet çš„æ‰€æœ‰ subnet    â”‚
â”‚ 2. AKS èˆ‡ Azure Fabric æ·±åº¦æ•´åˆ         â”‚
â”‚ 3. Node Pool API è§¸ç™¼ CNI è‡ªå‹•é‡é…ç½®    â”‚
â”‚ 4. ç„¡éœ€æ‰‹å‹•ç®¡ç† IP Pool æˆ–è·¯ç”±          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### è‡ªå‹•åŒ–ç‰¹æ€§
- âœ… **Zero-config**: æ–° Node Pool è‡ªå‹•é…ç½®ç¶²è·¯
- âœ… **å‹•æ…‹ç™¼ç¾**: è‡ªå‹•åµæ¸¬æ–°çš„ subnet é…ç½®
- âœ… **è·¯ç”±è‡ªå‹•åŒ–**: Azure Fabric è™•ç†æ‰€æœ‰è·¯ç”±
- âœ… **å¤§ç¯„åœæ”¯æ´**: å¯è¼•é¬†ä½¿ç”¨ 10.0.0.0/8 ç­‰å¤§ç¶²æ®µ

### åœ°ç«¯ CNI çš„é™åˆ¶

#### åŸºç¤è¨­æ–½éš”é›¢
```
åœ°ç«¯ CNI çš„ç¾å¯¦é™åˆ¶ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. CNI ç„¡æ³•æ§åˆ¶ç‰©ç†ç¶²è·¯è¨­å‚™             â”‚
â”‚ 2. ç„¡æ³•è‡ªå‹•ç™¼ç¾æ–°çš„ç¶²è·¯æ®µ               â”‚
â”‚ 3. éœ€è¦æ‰‹å‹•é…ç½® IP Pool å’Œè·¯ç”±          â”‚
â”‚ 4. å¤§ç¶²æ®µ (10.0.0.0/8) ç®¡ç†è¤‡é›œåº¦é«˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### æ”¯æ´å¤§ CIDR çš„åœ°ç«¯ CNI

| CNI | å¤§ CIDR æ”¯æ´ | å¯¦å‹™è€ƒé‡ |
|-----|-------------|---------|
| **Calico** | âœ… æ”¯æ´ 10.0.0.0/8 | è·¯ç”±è¡¨å¯èƒ½éå¤§ï¼Œéœ€è¦éšå±¤è¦åŠƒ |
| **Cilium** | âœ… æ”¯æ´ä½†éœ€èª¿å„ª | eBPF é™åˆ¶ï¼Œè¨˜æ†¶é«”ä½¿ç”¨é‡é«˜ |
| **Flannel** | âœ… åŸºæœ¬æ”¯æ´ | VXLAN å°åŒ…é–‹éŠ·ï¼Œæ•ˆèƒ½å½±éŸ¿ |

#### åœ°ç«¯æœ€ä½³å¯¦è¸
```yaml
# æ¨è–¦çš„åœ°ç«¯ç¶²æ®µè¦åŠƒ
å°å‹é›†ç¾¤: 10.0.0.0/16   (65K IP)
ä¸­å‹é›†ç¾¤: 10.0.0.0/12   (1M IP)  
å¤§å‹é›†ç¾¤: åˆ†å¤šå€‹é›†ç¾¤ç®¡ç†ï¼Œé¿å…å–®ä¸€å·¨å¤§ CIDR
```

## ğŸ—ï¸ é›²ç«¯ vs åœ°ç«¯æ¶æ§‹å·®ç•°

### Node Pool vs å€‹åˆ¥ Node ç®¡ç†

#### é›²ç«¯ (AKS) çš„ Node Pool æ¦‚å¿µ
```
AKS Node Pool ç‰¹æ€§ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Node Pool = ä¸€ç¾¤åŒè³ªåŒ–æ©Ÿå™¨çš„é›†åˆ        â”‚
â”‚                                         â”‚
â”‚ Dev Pool     â”‚ Stage Pool   â”‚ Prod Pool â”‚
â”‚ â”œâ”€ VM (åŒ)   â”‚ â”œâ”€ VM (åŒ)   â”‚ â”œâ”€ VM (åŒ) â”‚
â”‚ â”œâ”€ VM (åŒ)   â”‚ â”œâ”€ VM (åŒ)   â”‚ â”œâ”€ VM (åŒ) â”‚
â”‚ â””â”€ VM (åŒ)   â”‚ â””â”€ VM (åŒ)   â”‚ â””â”€ VM (åŒ) â”‚
â”‚              â”‚              â”‚           â”‚
â”‚ å„ªå‹¢:                                   â”‚
â”‚ - ç’°å¢ƒéš”é›¢æ¸…æ¥š                          â”‚
â”‚ - ç®¡ç†ç°¡å–®                              â”‚
â”‚ - è‡ªå‹•æ“´å±•                              â”‚
â”‚ - æ•…éšœè‡ªå‹•è™•ç†                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### åœ°ç«¯çš„å€‹åˆ¥ Node ç®¡ç†
```
åœ°ç«¯ Node ç‰¹æ€§ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ¯å°æ©Ÿå™¨éƒ½æ˜¯ç¨ç«‹å€‹é«”                    â”‚
â”‚                                         â”‚
â”‚ Cluster                                 â”‚
â”‚ â”œâ”€ Server-1 (Dell R640, 32GB)          â”‚
â”‚ â”œâ”€ Server-2 (HP DL380, 64GB)           â”‚
â”‚ â”œâ”€ Server-3 (Dell R740, 128GB)         â”‚
â”‚ â””â”€ Server-4 (èˆŠæ©Ÿå™¨, 16GB)             â”‚
â”‚                                         â”‚
â”‚ å„ªå‹¢:                                   â”‚
â”‚ - ç¡¬é«”ç•°è³ªåŒ–æ··ç”¨                        â”‚
â”‚ - æˆæœ¬å„ªåŒ–ç©ºé–“å¤§                        â”‚
â”‚ - é€æ­¥å‡ç´šå¯èƒ½                          â”‚
â”‚ - å®Œå…¨æ§åˆ¶æ¬Š                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ç’°å¢ƒéš”é›¢ç­–ç•¥

#### é›²ç«¯åšæ³•
```bash
# é€é Node Pool åšå¤©ç„¶éš”é›¢
az aks nodepool add --name dev-pool --node-taints="env=dev:NoSchedule"
az aks nodepool add --name prod-pool --node-taints="env=prod:NoSchedule"

# å·¥ä½œè² è¼‰è‡ªå‹•èª¿åº¦åˆ°å°æ‡‰ Pool
apiVersion: v1
kind: Pod
spec:
  nodeSelector:
    agentpool: prod-pool
```

#### åœ°ç«¯åšæ³•
```bash
# é€é Node æ¨™ç±¤å’Œ Taint åšéš”é›¢
kubectl label node server-1 env=dev
kubectl label node server-3 env=prod
kubectl taint node server-3 env=prod:NoSchedule

# éœ€è¦é¡å¤–çš„èª¿åº¦é‚è¼¯
```

## ğŸ”§ CNI CIDR ç®¡ç†æ©Ÿåˆ¶

### Azure CNI çš„ CIDR æª¢æŸ¥æ©Ÿåˆ¶

#### è‡ªå‹•é©—è­‰è¦å‰‡
```
å»ºç«‹ Node Pool æ™‚ Azure æœƒæª¢æŸ¥ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. Service CIDR è¡çªæª¢æŸ¥                â”‚
â”‚    âŒ ä¸å¯ä½¿ç”¨ 10.0.0.0/24             â”‚
â”‚                                         â”‚
â”‚ 2. VNet ç¯„åœæª¢æŸ¥                        â”‚
â”‚    âœ… å¿…é ˆåœ¨ 10.0.0.0/8 å…§             â”‚
â”‚                                         â”‚
â”‚ 3. Subnet é‡ç–Šæª¢æŸ¥                      â”‚
â”‚    âŒ ä¸å¯èˆ‡ç¾æœ‰ subnet é‡ç–Š            â”‚
â”‚                                         â”‚
â”‚ 4. å‹•æ…‹åŠ å…¥ CNI ç®¡ç†                    â”‚
â”‚    âœ… è‡ªå‹•ç´å…¥ CNI æ§åˆ¶ç¯„åœ             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### ç›®å‰çš„ç¶²è·¯åˆ†é…
```
å·²ä½¿ç”¨çš„ CIDR:
â”œâ”€â”€ 10.0.0.0/24  â† Service CIDR (è™›æ“¬ç¶²è·¯)
â”œâ”€â”€ 10.0.1.0/24  â† AKS Nodes & Pods  
â”œâ”€â”€ 10.0.2.0/24  â† Application Gateway
â””â”€â”€ 10.0.3.0/24+ â† å¯ç”¨æ–¼æ–° Node Pool

CNI å¯¦éš›ç®¡ç†:
â””â”€â”€ 10.0.1.0/24 (é€é Node Pool æŒ‡å®š)
    â”œâ”€â”€ Node IP: 10.0.1.10, 10.0.1.39
    â””â”€â”€ Pod IP:  10.0.1.10~10.0.1.57
```

### æ–° Node Pool çš„ç¶²è·¯æ•´åˆ

#### æ•´åˆæµç¨‹
```bash
# 1. å»ºç«‹æ–° subnet
az network vnet subnet create \
  --name subnet-aks-new \
  --address-prefix 10.0.3.0/24

# 2. å»ºç«‹ Node Pool ç¶å®šæ–° subnet
az aks nodepool add \
  --name newpool \
  --vnet-subnet-id "/subscriptions/.../subnets/subnet-aks-new"

# 3. Azure CNI è‡ªå‹•è™•ç†
# - å°‡ 10.0.3.0/24 ç´å…¥ç®¡ç†
# - å»ºç«‹è·¨ subnet è·¯ç”±
# - ç¢ºä¿ Pod é–“äº’é€š
```

#### è·¨ Subnet é€šè¨Šé©—è­‰
```
æ–°èˆŠ Node Pool äº’é€šæ€§ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Pod A (10.0.1.50) â†â†’ Pod B (10.0.3.20)  â”‚
â”‚                                         â”‚
â”‚ é€šè¨Šè·¯å¾‘:                               â”‚
â”‚ Pod A â†’ VNet è·¯ç”± â†’ Pod B               â”‚
â”‚                                         â”‚
â”‚ ç„¡éœ€é¡å¤–é…ç½®:                           â”‚
â”‚ âœ… Kubernetes Service è·¨ subnet é‹ä½œ    â”‚
â”‚ âœ… DNS è§£ææ­£å¸¸                         â”‚
â”‚ âœ… ç¶²è·¯ç­–ç•¥é©ç”¨                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ’¡ é—œéµç†è§£

### Azure CNI çš„æ ¸å¿ƒåƒ¹å€¼
1. **è‡ªå‹•åŒ–ç¨‹åº¦**: å°‡åœ°ç«¯æ‰‹å‹•ç®¡ç† IP Pool çš„å·¥ä½œå®Œå…¨è‡ªå‹•åŒ–
2. **å¹³å°æ•´åˆ**: èˆ‡ Azure VNet æ·±åº¦æ•´åˆï¼Œæä¾›ç„¡ç¸«é«”é©—
3. **å‹•æ…‹ç®¡ç†**: åªç®¡ç†è¢«æŒ‡æ´¾çµ¦ AKS çš„ subnetï¼Œä¸æ˜¯æ•´å€‹ VNet
4. **Zero-config**: æ–° Node Pool è‡ªå‹•ç²å¾—ç¶²è·¯é…ç½®

### åœ°ç«¯ CNI çš„ç¾å¯¦
1. **æ‰‹å‹•ç®¡ç†**: å¿…é ˆæ‰‹å‹•é…ç½®æ¯å€‹ IP Pool
2. **éœæ…‹è¦åŠƒ**: éœ€è¦é å…ˆè¦åŠƒç¶²è·¯æ‹“æ’²
3. **è¤‡é›œæ€§**: å¤§ç¶²æ®µç®¡ç†æœƒå¸¶ä¾†è·¯ç”±å’Œ IPAM è¤‡é›œåº¦
4. **éˆæ´»æ€§**: ä½†æä¾›æ›´é«˜çš„å®¢è£½åŒ–å½ˆæ€§

### æ¶æ§‹é¸æ“‡è€ƒé‡
1. **é›²ç«¯ Node Pool**: é©åˆæ¨™æº–åŒ–ç’°å¢ƒã€å¿«é€Ÿæ“´å±•ã€ç’°å¢ƒéš”é›¢
2. **åœ°ç«¯å€‹åˆ¥ Node**: é©åˆç¡¬é«”ç•°è³ªåŒ–ã€æˆæœ¬å„ªåŒ–ã€å®Œå…¨æ§åˆ¶

## ğŸš€ å¯¦å‹™å»ºè­°

### é›²ç«¯ç’°å¢ƒ
```bash
# å……åˆ†åˆ©ç”¨ Node Pool ç‰¹æ€§
Dev Environment:    Standard_B2s  (ä¾¿å®œ)
Stage Environment:  Standard_D4s  (ä¸­ç­‰)
Prod Environment:   Standard_D8s  (é«˜æ€§èƒ½)

# ç¶²è·¯è¦åŠƒ
æ¯å€‹ç’°å¢ƒä½¿ç”¨ä¸åŒ subnet:
dev:   10.0.10.0/24
stage: 10.0.20.0/24  
prod:  10.0.30.0/24
```

### åœ°ç«¯ç’°å¢ƒ
```yaml
# éšå±¤å¼ç¶²è·¯è¦åŠƒ
datacenter:
  rack1: 10.1.0.0/16
  rack2: 10.2.0.0/16
  rack3: 10.3.0.0/16

# é¿å…éå¤§çš„å–®ä¸€ CIDR
æ¨è–¦: å¤šå€‹ /16 è€Œéå–®ä¸€ /8
```

## çµè«–

Azure CNI é€šéèˆ‡ Azure å¹³å°çš„æ·±åº¦æ•´åˆï¼Œå¯¦ç¾äº†åœ°ç«¯ç’°å¢ƒé›£ä»¥é”åˆ°çš„è‡ªå‹•åŒ–ç¶²è·¯ç®¡ç†ã€‚å…¶ã€Œåªç®¡ç†è¢«æŒ‡æ´¾çš„ subnetã€çš„è¨­è¨ˆï¼Œæ—¢æä¾›äº†éˆæ´»æ€§ï¼Œåˆä¿æŒäº†ç®¡ç†çš„ç°¡æ½”æ€§ã€‚é€™ç¨®é›²ç«¯ç‰¹æœ‰çš„æ¶æ§‹å„ªå‹¢ï¼Œæ­£æ˜¯ä¼æ¥­é¸æ“‡è¨—ç®¡ Kubernetes æœå‹™çš„é‡è¦åŸå› ä¹‹ä¸€ã€‚

---

*æ–‡æª”å»ºç«‹æ—¥æœŸï¼š2025-08-15*  
*åŸºæ–¼ AKS é›†ç¾¤ï¼šaks-dev-cluster (East Asia)*  
*VNet é…ç½®ï¼švnet-aks-dev (10.0.0.0/8)*